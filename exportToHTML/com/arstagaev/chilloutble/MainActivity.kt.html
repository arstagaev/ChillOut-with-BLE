<html>
<head>
<title>MainActivity.kt</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
MainActivity.kt</font>
</center></td></tr></table>
<pre><span class="s0">package </span><span class="s1">com.arstagaev.chilloutble</span>

<span class="s1">import android.Manifest</span>
<span class="s1">import android.content.Intent</span>
<span class="s1">import android.os.Build</span>
<span class="s1">import android.os.Bundle</span>
<span class="s1">import androidx.activity.ComponentActivity</span>
<span class="s1">import androidx.activity.compose.setContent</span>
<span class="s1">import androidx.compose.foundation.clickable</span>
<span class="s1">import androidx.compose.foundation.layout.*</span>
<span class="s1">import androidx.compose.material.*</span>
<span class="s1">import androidx.compose.ui.Alignment</span>
<span class="s1">import androidx.compose.ui.Modifier</span>
<span class="s1">import androidx.compose.ui.graphics.Color</span>
<span class="s1">import androidx.compose.ui.text.style.TextAlign</span>
<span class="s1">import androidx.compose.ui.unit.dp</span>
<span class="s1">import androidx.lifecycle.coroutineScope</span>
<span class="s1">import androidx.lifecycle.lifecycleScope</span>
<span class="s1">import com.arstagaev.chilloutble.ui.theme.ChillOutBLETheme</span>
<span class="s1">import com.arstagaev.flowble.*</span>
<span class="s1">import com.arstagaev.flowble.enums.*</span>
<span class="s1">import com.arstagaev.flowble.gentelman_kit.bytesToHex</span>
<span class="s1">import com.arstagaev.flowble.extensions.hasPermission</span>
<span class="s1">import com.arstagaev.flowble.gentelman_kit.logWarning</span>
<span class="s1">import com.arstagaev.flowble.extensions.requestPermission</span>
<span class="s1">import kotlinx.coroutines.*</span>
<span class="s1">import java.util.*</span>
<span class="s1">import kotlin.coroutines.CoroutineContext</span>

<span class="s0">class </span><span class="s1">MainActivity : ComponentActivity() {</span>


    <span class="s0">var </span><span class="s1">bleStarter : BLEStarter? = </span><span class="s0">null</span>

    <span class="s1">override </span><span class="s0">fun </span><span class="s1">onCreate(savedInstanceState: Bundle?) {</span>
        <span class="s0">super</span><span class="s1">.onCreate(savedInstanceState)</span>

        <span class="s2">// here we receive bytes from Notify characteristic:</span>
        <span class="s1">CoroutineScope(lifecycleScope.coroutineContext).launch {</span>
            <span class="s1">BLEStarter.outputBytesNotifyIndicate.collect {</span>
                <span class="s1">logWarning(</span><span class="s3">&quot;Result: </span><span class="s0">${</span><span class="s1">bytesToHex(it.value!!)</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s1">)</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">// here we get found devices after scanning:</span>
        <span class="s1">CoroutineScope(lifecycleScope.coroutineContext).launch {</span>
            <span class="s1">BLEStarter.scanDevices.collect {</span>
                <span class="s1">logWarning(</span><span class="s3">&quot;What I found: </span><span class="s0">${</span><span class="s1">it</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s1">)</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s1">setContent {</span>
            <span class="s1">ChillOutBLETheme {</span>
                <span class="s2">// A surface container using the 'background' color from the theme</span>
                <span class="s1">Surface(</span>
                    <span class="s1">modifier = Modifier.fillMaxSize()</span><span class="s0">,</span>
                    <span class="s1">color = Color.White</span>
                <span class="s1">) {</span>
                    <span class="s1">Box(modifier = Modifier</span>
                        <span class="s1">.fillMaxSize()) {</span>
                        <span class="s1">Column(modifier = Modifier.align(Alignment.Center)</span><span class="s0">,</span>
                            <span class="s1">horizontalAlignment = Alignment.CenterHorizontally</span><span class="s0">,</span>
                            <span class="s1">verticalArrangement = Arrangement.SpaceBetween) {</span>
                            <span class="s1">Button(</span>
                                <span class="s1">modifier = Modifier</span>
                                    <span class="s1">.width(</span><span class="s4">200</span><span class="s1">.dp)</span>
                                    <span class="s1">.height(</span><span class="s4">90</span><span class="s1">.dp)</span>
                                    <span class="s1">.padding(vertical = </span><span class="s4">10</span><span class="s1">.dp)</span>
                                    <span class="s1">.clickable { }</span><span class="s0">,</span><span class="s1">colors = ButtonDefaults.buttonColors(backgroundColor = Color.Blue)</span>
                                <span class="s0">, </span><span class="s1">onClick = {</span>

                                    <span class="s0">if </span><span class="s1">(isAllPermissionsEnabled()) {</span>
                                        <span class="s1">launchLib()</span>
                                    <span class="s1">}</span>

                                <span class="s1">}</span>
                            <span class="s1">) {</span>
                                <span class="s1">Text(modifier = Modifier</span><span class="s0">, </span><span class="s1">text = </span><span class="s3">&quot;Start Chill Out&quot;</span><span class="s0">,</span><span class="s1">textAlign = TextAlign.Center</span><span class="s0">, </span><span class="s1">color = Color.White)</span>
                            <span class="s1">}</span>
                            <span class="s1">Button(</span>
                                <span class="s1">modifier = Modifier</span>
                                    <span class="s1">.width(</span><span class="s4">200</span><span class="s1">.dp)</span>
                                    <span class="s1">.height(</span><span class="s4">90</span><span class="s1">.dp)</span>
                                    <span class="s1">.padding(vertical = </span><span class="s4">10</span><span class="s1">.dp)</span>
                                    <span class="s1">.clickable { }</span><span class="s0">,</span><span class="s1">colors = ButtonDefaults.buttonColors(backgroundColor = Color.Red)</span>
                                <span class="s0">, </span><span class="s1">onClick = {</span>

                                    <span class="s0">if </span><span class="s1">(isAllPermissionsEnabled()) {</span>
                                        <span class="s1">stopLib()</span>
                                    <span class="s1">}</span>

                                <span class="s1">}</span>
                            <span class="s1">) {</span>
                                <span class="s1">Text(modifier = Modifier</span><span class="s0">, </span><span class="s1">text = </span><span class="s3">&quot;Stop Chill Out&quot;</span><span class="s0">,</span><span class="s1">textAlign = TextAlign.Center</span><span class="s0">, </span><span class="s1">color = Color.White)</span>
                            <span class="s1">}</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">// How to use library:</span>
    <span class="s1">private </span><span class="s0">fun </span><span class="s1">launchLib() {</span>
        <span class="s1">bleStarter = BLEStarter(</span><span class="s0">this</span><span class="s1">)</span>

        <span class="s1">CoroutineScope(lifecycleScope.coroutineContext).launch {</span>
            <span class="s1">BLEStarter.bleCommandTrain.emit(mutableListOf(</span>
                <span class="s1">StartScan()</span><span class="s0">,</span>
                <span class="s1">DelayOpera(</span><span class="s4">6000L</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">Connect(</span><span class="s3">&quot;44:44:44:44:44:0C&quot;</span><span class="s0">, </span><span class="s1">isImportant = </span><span class="s0">true</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">StopScan()</span><span class="s0">,</span>
                <span class="s1">ReadFromCharacteristic(</span><span class="s3">&quot;44:44:44:44:44:0C&quot;</span><span class="s0">,</span><span class="s1">UUID.fromString(</span><span class="s3">&quot;beb5483e-36e1-4688-b7f5-ea07361b26a8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">isImportant = </span><span class="s0">true</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">EnableNotifications(</span><span class="s3">&quot;44:44:44:44:44:0C&quot;</span><span class="s0">,</span><span class="s1">UUID.fromString(</span><span class="s3">&quot;beb54202-36e1-4688-b7f5-ea07361b26a8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">isImportant = </span><span class="s0">true</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">DisableNotifications(</span><span class="s3">&quot;44:44:44:44:44:0C&quot;</span><span class="s0">, </span><span class="s1">UUID.fromString(</span><span class="s3">&quot;beb54202-36e1-4688-b7f5-ea07361b26a8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">isImportant = </span><span class="s0">true</span><span class="s1">)</span>
            <span class="s1">))</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">fun </span><span class="s1">stopLib() {</span>
        <span class="s1">CoroutineScope(CoroutineName(</span><span class="s3">&quot;stop&quot;</span><span class="s1">)+ (lifecycleScope.coroutineContext)).launch {</span>
            <span class="s1">bleStarter?.forceStop()</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">isAllPermissionsEnabled(): Boolean {</span>
        <span class="s0">if </span><span class="s1">(Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.S) {</span>
            <span class="s0">if </span><span class="s1">(!hasPermission(Manifest.permission.BLUETOOTH_CONNECT)) {</span>
                <span class="s1">requestPermission(Manifest.permission.BLUETOOTH_CONNECT</span><span class="s0">,</span><span class="s4">1</span><span class="s1">)</span>
                <span class="s0">return false</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(!hasPermission(Manifest.permission.BLUETOOTH_SCAN)) {</span>
                <span class="s1">requestPermission(Manifest.permission.BLUETOOTH_SCAN</span><span class="s0">,</span><span class="s4">2</span><span class="s1">)</span>
                <span class="s0">return false</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!hasPermission(Manifest.permission.ACCESS_FINE_LOCATION)) {</span>
            <span class="s1">requestPermission(Manifest.permission.ACCESS_FINE_LOCATION</span><span class="s0">,</span><span class="s4">3</span><span class="s1">)</span>
            <span class="s0">return false</span>
        <span class="s1">}</span>
        <span class="s0">return true</span>
    <span class="s1">}</span>

    <span class="s1">override </span><span class="s0">fun </span><span class="s1">onDestroy() {</span>

        <span class="s0">super</span><span class="s1">.onDestroy()</span>

    <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>